on:
  workflow_dispatch:
    inputs:
      AS_ARTIFACTS:
        description: "Upload as artifacts"
        required: false
        default: 'false'
      OLD_CACHE:
        description: "Previous cache version"
        required: false
      NEW_CACHE:
        description: "Next cache version"
        required: false

name: Sprite differ
jobs:
  compare:
    name: "Sprite comparison between OSRS revs"
    runs-on: ubuntu-latest
    steps:
      - name: Output Inputs
        run: echo "${{ toJSON(github.event.inputs) }}"

      - uses: actions/checkout@v6

      - name: Fetch resource-packs sample-vanilla
        uses: actions/checkout@v6
        with:
          repository: 'melkypie/resource-packs'
          ref: 'refs/heads/sample-vanilla'
          path: 'sample-vanilla'
          ssh-key: ${{ secrets.RP_DEPLOY_KEY }}

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Generate sprites
        id: build
        env:
          OLD_CACHE: ${{ github.event.inputs.OLD_CACHE }}
          NEW_CACHE: ${{ github.event.inputs.NEW_CACHE }}
        run: |
          # Capture output to a file
          ./gradlew generatePack > gradle_output.txt 2>&1
          # Store the file content properly
          OUTPUT=$(cat gradle_output.txt)
          # Escape the content for GitHub output
          OUTPUT="${OUTPUT//'%'/'%25'}"
          OUTPUT="${OUTPUT//$'\n'/'%0A'}"
          OUTPUT="${OUTPUT//$'\r'/'%0D'}"
          echo "sysout=${OUTPUT}" >> $GITHUB_OUTPUT

      - name: Set cache name
        id: parsed
        run: |
          SYS_OUTPUT="${{ steps.build.outputs.sysout }}"
          OUTPUT=$(echo "$SYS_OUTPUT" | grep -oP 'Using version: \K.*' | head -1)
          echo "new_cache=$OUTPUT" >> $GITHUB_OUTPUT

      - name: Zip sprites
        env:
          NEW_CACHE: ${{ steps.parsed.outputs.new_cache }}
        run: |
          zip -qr cache/$NEW_CACHE-sprites.zip cache/$NEW_CACHE/sprites

      - name: Upload sprites
        if: ${{ github.event.inputs.AS_ARTIFACTS == 'true'}}
        uses: actions/upload-artifact@v4
        with:
          name: sprite-${{ steps.parsed.outputs.new_cache }}
          path: |
            cache/*-sprites.zip

      - name: Echo changes
        run: Add changes by update ${{ steps.parsed.outputs.new_cache }}

#      - name: Push changes to sample-vanilla
#        uses: EndBug/add-and-commit@v7
#        with:
#          add: '-A'
#          message: Add changes by update ${{ steps.build.outputs.new_cache }}
#          branch: sample-vanilla
#          pull_strategy: 'NO-PULL'
#          cwd: './sample-vanilla'
#          default_author: github_actions


    
